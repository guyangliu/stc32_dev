C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE CNU_PIE_I2C
OBJECT MODULE PLACED IN .\Objects\CNU_PIE_I2C.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE ..\..\..\Libraries\deivers\src\CNU_PIE_I2C.c XSMALL BROWSE INCDIR(..\.
                    -.\..\Libraries\boards\inc;..\..\..\Libraries\startup\inc;..\USER\inc;..\..\..\Libraries\deivers\inc) DEBUG PRINT(.\Listi
                    -ngs\CNU_PIE_I2C.lst) TABS(2) OBJECT(.\Objects\CNU_PIE_I2C.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           *     COPYRIGHT NOTICE
    3           *     Copyright (c) 2023,CNU_W.PIE
    4           *     All rights reserved.
    5           *
    6           *     ³ý×¢Ã÷³ö´¦Íâ£¬ÒÔÏÂËùÓÐÄÚÈÝ°æÈ¨¾ùÊôÅÖÅÖ¸öÈËËùÓÐ£¬Î´¾­ÔÊÐí£¬²»µÃÓÃÓÚÉÌÒµÓÃÍ¾£¬
    7           *     ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôPPµÄ°æÈ¨ÉùÃ÷¡£
    8           *     Except where indicated, the copyright of all the contents below is owned by PP 
    9           *     and can not be used for commercial purposes without permission. 
   10           *     The copyright notice of PP must be preserved when modifying the content.
   11           *
   12           * @file       CNU_PIE_I2C.c
   13           * @brief      I2C
   14           * @author     ÅÖÅÖ
   15           * @version    v1.0
   16           * @note       NULL
   17           * @date       2023-07-26
   18           ********************************************************************************************************
             -************/
   19          #include "CNU_PIE_I2C.h"
   20          #include "CNU_PIE_GPIO.h"
   21          
   22           /*******************************************************************************************************
             -*******************
   23           * @brief  I2CÖ÷»úÒý½Å³õÊ¼»¯
   24           * @exampleCode
   25           *      I2C_Init_Master(IIC_1, 400*1000, 0 , 1); //³õÊ¼»¯I2C1 ×ÜÏßËÙÂÊ400k ½ûÖ¹×ÜÏß×Ô¶¯·¢ËÍ ¿ªÆôI2C×ÜÏß
   26           * @endcode
   27           * @param[in]  I2C_enum       IICÍ¨µÀÃ¶¾Ù
   28           * @param[in]  I2C_BUS_Rate   IIC×ÜÏßËÙÂÊ              
   29           * @param[in]  I2C_WDTA_EN    IIC×Ô¶¯·¢ËÍÎ»
   30           * @param[in]  I2C_Enable     IICÊ¹ÄÜÎ»
   31          *********************************************************************************************************
             -******************/
   32          void  I2C_Init_Master(IIC_ENUM I2C_enum , uint32_t I2C_BUS_Rate , uint8_t I2C_WDTA_EN , uint8_t I2C_Enable
             -)
   33          {
   34   1        uint8_t Bus_Speed;
   35   1        switch(I2C_enum)
   36   1          {
   37   2          case IIC_1:
   38   2              P_SW2 |= (0x00<<4); //SCL:P1.5  SDA:P1.4
   39   2              break;
   40   2          case IIC_2:
   41   2              P_SW2 |= (0x01<<4); //SCL:P2.5  SDA:P2.4
   42   2              break;
   43   2          case IIC_3:
   44   2              P_SW2 |= (0x02<<4); //SCL:P7.7  SDA:P7.6
   45   2              break;
   46   2          case IIC_4:
   47   2              P_SW2 |= (0x03<<4); //SCL:P3.2  SDA:P3.3
   48   2              break;
   49   2          }
   50   1      
   51   1        I2CCFG |=  0x40;  //ÉèÖÃµ±Ç°Éè±¸ÎªI2CÖ÷»ú
   52   1        I2CMSST = 0x00;   //Çå³ýI2CÖ÷»ú×´Ì¬¼Ä´æÆ÷
C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 2   

   53   1        /* I2C_BUS_Rate=Fosc/2/(Bus_Speed*2+4) */
   54   1        Bus_Speed = (uint8_t)(FOSC/4*I2C_BUS_Rate)-4;
   55   1        I2CCFG = ((I2CCFG & ~0x3f) | (Bus_Speed & 0x3f));//ÉèÖÃ×ÜÏßËÙ¶È
   56   1        if(I2C_WDTA_EN) I2CMSAUX |= 0x01;//Ê¹ÄÜ×Ô¶¯·¢ËÍ
   57   1        else I2CMSAUX &= ~0x01;          //½ûÖ¹×Ô¶¯·¢ËÍ
   58   1        (I2C_Enable==0?(I2CCFG &= ~0x80):(I2CCFG |= 0x80));       
   59   1      }
   60           /*******************************************************************************************************
             -*******************
   61           * @brief  I2C´Ó»úÒý½Å³õÊ¼»¯
   62           * @exampleCode
   63           *      I2C_Init_Slave(IIC_1, 0xab , 1 , 1 , 1); //³õÊ¼»¯I2C1Îª´Ó»ú µØÖ·0xab Ö»½ÓÊÜÏàÆ¥ÅäµØÖ· ¿ªÆôI2C×ÜÏß
   64           * @endcode
   65           * @param[in]  I2C_enum        IICÍ¨µÀÃ¶¾Ù
   66           * @param[in]  I2C_Slave_Add   IIC´Ó»úµØÖ·              
   67           * @param[in]  I2C_MATCH_EN    IIC´Ó»úµØÖ·±È½Ï
   68           * @param[in]  I2C_Enable      IICÊ¹ÄÜÎ»
   69          *********************************************************************************************************
             -******************/
   70          void  I2C_Init_Slave(IIC_ENUM I2C_enum , uint8_t I2C_Slave_Add , uint8_t I2C_MATCH_EN , uint8_t I2C_Enable
             -)
   71          {
   72   1        switch(I2C_enum)
   73   1          {
   74   2          case IIC_1:
   75   2              P_SW2 |= (0x00<<4); //SCL:P1.5  SDA:P1.4
   76   2              break;
   77   2          case IIC_2:
   78   2              P_SW2 |= (0x01<<4); //SCL:P2.5  SDA:P2.4
   79   2              break;
   80   2          case IIC_3:
   81   2              P_SW2 |= (0x02<<4); //SCL:P7.7  SDA:P7.6
   82   2              break;
   83   2          case IIC_4:
   84   2              P_SW2 |= (0x03<<4); //SCL:P3.2  SDA:P3.3
   85   2              break;
   86   2          }
   87   1      
   88   1        I2CCFG &= ~0x40;  //ÉèÖÃµ±Ç°Éè±¸ÎªI2CÖ÷»ú
   89   1        I2CSLST = 0x00;   //Çå³ýI2C´Ó»ú×´Ì¬¼Ä´æÆ÷
   90   1          
   91   1      //  I2CSLST = 0X00;   //½ÓÊÕÖÐ¶Ï
   92   1      //  I2CSLCR = 0x78;   //½ÓÊÜÖÐ¶Ï
   93   1          
   94   1        I2CSLADR = ((I2CSLADR & 0x01) | (I2C_Slave_Add << 1));//ÉèÖÃµ±Ç°Éè±¸µØÖ·
   95   1        if(I2C_MATCH_EN) I2CSLADR &= ~0x01;//Ê¹ÄÜ´Ó»úµØÖ·±È½Ï¹¦ÄÜ£¬Ö»½ÓÊÜÏàÆ¥ÅäµØÖ·
   96   1        else I2CSLADR |= 0x01;             //½ûÖ¹´Ó»úµØÖ·±È½Ï¹¦ÄÜ£¬½ÓÊÜËùÓÐÉè±¸µØÖ·
   97   1        (I2C_Enable==0?(I2CCFG &= ~0x80):(I2CCFG |= 0x80));       
   98   1      } 
   99           /*******************************************************************************************************
             -*******************
  100           * @brief  »ñÈ¡Ö÷»úÃ¦Âµ×´Ì¬.
  101           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  102          *********************************************************************************************************
             -******************/
  103          uint8_t Get_MSBusy_Status(void)
  104          {
  105   1        return (I2CMSST & 0x80);
  106   1      }
  107           /*******************************************************************************************************
             -*******************
  108           * @brief  µÈ´ýÖ÷»úÄ£Ê½I2C¿ØÖÆÆ÷Ö´ÐÐÍê³ÉI2CMSCR.
  109           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  110          *********************************************************************************************************
             -******************/
  111          void Wait()
C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 3   

  112          {
  113   1        while (!(I2CMSST & 0x40));
  114   1        I2CMSST &= ~0x40;
  115   1      }
  116           /*******************************************************************************************************
             -*******************
  117           * @brief  I2C×ÜÏßÆðÊ¼º¯Êý.
  118           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  119          *********************************************************************************************************
             -******************/
  120          void Start()
  121          {
  122   1        I2CMSCR = 0x01;                         //·¢ËÍSTARTÃüÁî
  123   1        Wait();
  124   1      }
  125           /*******************************************************************************************************
             -*******************
  126           * @brief  I2C·¢ËÍÒ»¸ö×Ö½ÚÊý¾Ýº¯Êý.
  127           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  128          *********************************************************************************************************
             -******************/
  129          void SendData(char dat)
  130          {
  131   1        I2CTXD = dat;                           //Ð´Êý¾Ýµ½Êý¾Ý»º³åÇø
  132   1        I2CMSCR = 0x02;                         //·¢ËÍSENDÃüÁî
  133   1        Wait();
  134   1      }
  135           /*******************************************************************************************************
             -*******************
  136           * @brief  I2C»ñÈ¡ACKº¯Êý.
  137           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  138          *********************************************************************************************************
             -******************/
  139          void RecvACK()
  140          {
  141   1        I2CMSCR = 0x03;                         //·¢ËÍ¶ÁACKÃüÁî
  142   1        Wait();
  143   1      }
  144           /*******************************************************************************************************
             -*******************
  145           * @brief  I2C¶ÁÈ¡Ò»¸ö×Ö½ÚÊý¾Ýº¯Êý.
  146           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  147          *********************************************************************************************************
             -******************/
  148          char RecvData()
  149          {
  150   1        I2CMSCR = 0x04;                         //·¢ËÍRECVÃüÁî
  151   1        Wait();
  152   1        return I2CRXD;
  153   1      }
  154           /*******************************************************************************************************
             -*******************
  155           * @brief  I2C·¢ËÍACKº¯Êý.
  156           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  157          *********************************************************************************************************
             -******************/
  158          void SendACK()
  159          {
  160   1        I2CMSST = 0x00;                         //ÉèÖÃACKÐÅºÅ
  161   1        I2CMSCR = 0x05;                         //·¢ËÍACKÃüÁî
  162   1        Wait();
  163   1      }
  164           /*******************************************************************************************************
             -*******************
  165           * @brief  I2C·¢ËÍNAKº¯Êý.
  166           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 4   

  167          *********************************************************************************************************
             -******************/
  168          void SendNAK()
  169          {
  170   1        I2CMSST = 0x01;                         //ÉèÖÃNAKÐÅºÅ
  171   1        I2CMSCR = 0x05;                         //·¢ËÍACKÃüÁî
  172   1        Wait();
  173   1      }
  174           /*******************************************************************************************************
             -*******************
  175           * @brief  I2C×ÜÏßÍ£Ö¹º¯Êý.
  176           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  177          *********************************************************************************************************
             -******************/
  178          void Stop()
  179          {
  180   1        I2CMSCR = 0x06;                         //·¢ËÍSTOPÃüÁî
  181   1        Wait();
  182   1      }
  183           /*******************************************************************************************************
             -*******************
  184           * @brief  I2C·¢ËÍÒ»¸ö×Ö½ÚÊý¾Ýº¯Êý.
  185           * @brief  ÄÚ²¿µ÷ÓÃ£¬ÎÞÐè¹ØÐÄ
  186          *********************************************************************************************************
             -******************/
  187          void SendCmdData(uint8_t cmd, uint8_t dat)
  188          {
  189   1        I2CTXD = dat;                           //Ð´Êý¾Ýµ½Êý¾Ý»º³åÇø
  190   1        I2CMSCR = cmd;                          //ÉèÖÃÃüÁî
  191   1        Wait();
  192   1      }
  193           /*******************************************************************************************************
             -*******************
  194           * @brief  I2CÐ´ÈëÊý¾Ýº¯Êý
  195           * @exampleCode
  196            uint8_t cmd[2];
  197            cmd[0]=0x00;
  198            cmd[1]=WrCmd;
  199            I2C_WriteNbyte(0x7a,cmd[0],&cmd[1],1); //Ïò0x7aÎªµØÖ·µÄÉè±¸ µÄ0x00µØÖ·µÄ¼Ä´æÆ÷ Ð´Èë WrcmdÊý¾Ý ³¤¶È1×Ö½Ú
  200           * @endcode
  201           * @param[in]  addr    Ö¸¶¨µØÖ· 
  202           * @param[in]  reg     ¼Ä´æÆ÷µØÖ·              
  203           * @param[in]  *p      Ð´ÈëÊý¾Ý´æ´¢Î»ÖÃ
  204           * @param[in]  number  Ð´ÈëÊý¾Ý¸öÊý
  205          *********************************************************************************************************
             -******************/
  206          void I2C_WriteNbyte(uint8_t addr, uint8_t reg , uint8_t *p, uint8_t number) reentrant /*  WordAddress,Fir
             -st Data Address,Byte lenth   */
  207          {
  208   1        Start();                                //·¢ËÍÆðÊ¼ÃüÁî
  209   1        SendData(addr);                         //·¢ËÍÉè±¸µØÖ·+Ð´ÃüÁî
  210   1        RecvACK();
  211   1        SendData(reg);                         //·¢ËÍ´æ´¢µØÖ·
  212   1        RecvACK();
  213   1        do
  214   1        {
  215   2          SendData(*p++);
  216   2          RecvACK();
  217   2        }
  218   1        while(--number);
  219   1        Stop();                                 //·¢ËÍÍ£Ö¹ÃüÁî
  220   1      }
  221           /*******************************************************************************************************
             -*******************
  222           * @brief  I2C¶ÁÈ¡Êý¾Ýº¯Êý
  223           * @exampleCode
C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 5   

  224            uint8_t reg,uint8_t *pbuf
  225            I2C_ReadNbyte(0x7a,reg,pbuf,1); //Ïò0x7aÎªµØÖ·µÄÉè±¸ µÄregµØÖ·µÄ¼Ä´æÆ÷ ¶ÁÈ¡Êý¾Ý ³¤¶È1×Ö½Ú ²¢´æÈëpbufµÄµ
             -ØÖ·ÄÚ
  226           * @endcode
  227           * @param[in]  addr    Ö¸¶¨µØÖ· 
  228           * @param[in]  reg     ¼Ä´æÆ÷µØÖ·              
  229           * @param[in]  *p      Ð´ÈëÊý¾Ý´æ´¢Î»ÖÃ
  230           * @param[in]  number  ¶ÁÈ¡Êý¾Ý¸öÊý
  231          *********************************************************************************************************
             -******************/
  232          void I2C_ReadNbyte(uint8_t addr, uint8_t reg , uint8_t *p, uint8_t number)   
  233          {
  234   1        Start();                                //·¢ËÍÆðÊ¼ÃüÁî
  235   1        SendData(addr);                         //·¢ËÍÉè±¸µØÖ·+Ð´ÃüÁî
  236   1        RecvACK();
  237   1        SendData(reg);                         //·¢ËÍ´æ´¢µØÖ·
  238   1        RecvACK();
  239   1        Start();                                //·¢ËÍÆðÊ¼ÃüÁî
  240   1        SendData((uint8_t)(addr+1));                         //·¢ËÍÉè±¸µØÖ·+¶ÁÃüÁî
  241   1        RecvACK();
  242   1        do
  243   1        {
  244   2          *p = RecvData();
  245   2          p++;
  246   2          if(number != 1) SendACK();          //send ACK
  247   2        }
  248   1        while(--number);
  249   1        SendNAK();                              //send no ACK 
  250   1        Stop();                               //·¢ËÍÍ£Ö¹ÃüÁî 
  251   1      }
  252           /*******************************************************************************************************
             -*******************
  253           * @brief  I2CÒý½ÅÇÐ»»º¯Êý
  254           * @exampleCode
  255             I2C_Change_Pin(IIC_3);
  256           * @endcode
  257           * @param[in]  I2C_enum    ÐèÒªÇÐ»»µ½ÄÄ×éIICÒý½Å 
  258          *********************************************************************************************************
             -******************/
  259          void I2C_Change_Pin(IIC_ENUM I2C_enum)
  260          {
  261   1          P_SW2 |= 0x80;//È·¶¨Ê¹ÄÜ·ÃÎÊXFR
  262   1        
  263   1          P_SW2 &= ~(0x03<<4);  //Çå³ýÒý½ÅÇÐ»»Î»
  264   1          switch(I2C_enum)  
  265   1          {
  266   2          case IIC_1:
  267   2              P_SW2 |= (0x00<<4); //SCL:P1.5  SDA:P1.4
  268   2              break;
  269   2          case IIC_2:
  270   2              P_SW2 |= (0x01<<4); //SCL:P2.5  SDA:P2.4
  271   2              break;
  272   2          case IIC_3:
  273   2              P_SW2 |= (0x02<<4); //SCL:P7.7  SDA:P7.6 STC8H 48½ÅºËÐÄ°åÃ»ÓÐ¸Ã×éÒý½Å¡£
  274   2              break;
  275   2          case IIC_4:
  276   2              P_SW2 |= (0x03<<4); //SCL:P3.2  SDA:P3.3
  277   2              break;
  278   2          }
  279   1        
  280   1        P_SW2 |= 0x80;//È·¶¨Ê¹ÄÜ·ÃÎÊXFR
  281   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       708     ------
C251 COMPILER V5.60.0,  CNU_PIE_I2C                                                        06/10/23  08:20:08  PAGE 6   

  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------          3
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
